<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexibility of the dimensionality reduction assessment • ClustAssess</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Flexibility of the dimensionality reduction assessment">
<meta property="og:description" content="ClustAssess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ClustAssess</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/ClustAssess.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/comparing-soft-and-hierarchical.html">Comparing soft and hierarchical clusterings with element-centric similarity</a>
    </li>
    <li>
      <a href="../articles/dim_reduction_flexibility.html">Flexibility of the dimensionality reduction assessment</a>
    </li>
    <li>
      <a href="../articles/stability-pipeline-description.html">Stability-based parameter assessment</a>
    </li>
    <li>
      <a href="../articles/stability-pipeline-shiny.html">Automatic ClustAssess pipeline. Generating the ClustAssess shiny-app</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Core-Bioinformatics/ClustAssess/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Flexibility of the dimensionality reduction
assessment</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Core-Bioinformatics/ClustAssess/blob/HEAD/vignettes/dim_reduction_flexibility.Rmd" class="external-link"><code>vignettes/dim_reduction_flexibility.Rmd</code></a></small>
      <div class="hidden name"><code>dim_reduction_flexibility.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: SeuratObject</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: sp</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'SeuratObject'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.satijalab.org/seurat" class="external-link">SeuratData</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Installed datasets</span> ──────────────────────────────── SeuratData v0.2.2.9001 ──</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">pbmc3k      </span> 3.1.4                    <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">pbmcMultiome</span> 0.1.4</span></span></code></pre>
<pre><code><span><span class="co">## ────────────────────────────────────── Key ─────────────────────────────────────</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Dataset loaded successfully</span></span>
<span><span class="co">## <span style="color: #BBBB00;">❯</span> Dataset built with a newer version of Seurat than installed</span></span>
<span><span class="co">## <span style="color: #BB0000;">❓</span> Unknown version of Seurat installed</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Core-Bioinformatics/ClustAssess" class="external-link">ClustAssess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">harmony</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: Rcpp</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_repetitions</span> <span class="op">&lt;-</span> <span class="fl">30</span></span></code></pre></div>
<p>The <code>matrix processing</code> parameter of the
<code>assess_feature_stability</code> function is a function that
enables the user to specify any method to perform the dimensionality
reduction prior to applying the UMAP algorithm and the clustering
pipeline. By default, the dimensionality reduction used in
<code>ClustAssess</code> is a precise PCA using the <code>prcomp</code>
package. However, this function can be easily changed, as it will be
shown in the following examples.</p>
<div class="section level2">
<h2 id="clustassess-using-pca">ClustAssess using PCA<a class="anchor" aria-label="anchor" href="#clustassess-using-pca"></a>
</h2>
<p>For the PCA example, we will use the PBMC 3k dataset from the
<code>SeuratData</code> package. The preprocessing of the dataset is
identical with the one performed in the stability pipeline vignette.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/InstallData.html" class="external-link">InstallData</a></span><span class="op">(</span><span class="st">"pbmc3k"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: The following packages are already installed and will not be</span></span>
<span><span class="co">## reinstalled: pbmc3k</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"pbmc3k"</span><span class="op">)</span></span>
<span><span class="va">pbmc3k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/UpdateSeuratObject.html" class="external-link">UpdateSeuratObject</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Validating object structure</span></span></code></pre>
<pre><code><span><span class="co">## Updating object slots</span></span></code></pre>
<pre><code><span><span class="co">## Ensuring keys are in the proper structure</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Assay RNA changing from Assay to Assay</span></span></code></pre>
<pre><code><span><span class="co">## Ensuring keys are in the proper structure</span></span></code></pre>
<pre><code><span><span class="co">## Ensuring feature names don't have underscores or pipes</span></span></code></pre>
<pre><code><span><span class="co">## Updating slots in RNA</span></span></code></pre>
<pre><code><span><span class="co">## Validating object structure for Assay 'RNA'</span></span></code></pre>
<pre><code><span><span class="co">## Object representation is consistent with the most current Seurat version</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbmc3k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmc3k</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span>, col.name <span class="op">=</span> <span class="st">"percent.mito"</span><span class="op">)</span></span>
<span><span class="va">pbmc3k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmc3k</span>, pattern <span class="op">=</span> <span class="st">"^RP[SL][[:digit:]]"</span>, col.name <span class="op">=</span> <span class="st">"percent.rp"</span><span class="op">)</span></span>
<span><span class="co"># remove MT and RP genes</span></span>
<span><span class="va">all.index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">MT.index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"^MT-"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">RP.index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"^RP[SL][[:digit:]]"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pbmc3k</span> <span class="op">&lt;-</span> <span class="va">pbmc3k</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="va">all.index</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">MT.index</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">all.index</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">RP.index</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">pbmc3k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmc3k</span>, <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2000</span> <span class="op">&amp;</span> <span class="va">nCount_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mito</span> <span class="op">&lt;</span> <span class="fl">7</span> <span class="op">&amp;</span> <span class="va">percent.rp</span> <span class="op">&gt;</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">pbmc3k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">pbmc3k</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pbmc3k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">pbmc3k</span>, selection.method <span class="op">=</span> <span class="st">"vst"</span>, nfeatures <span class="op">=</span> <span class="fl">3000</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">var_features</span> <span class="op">&lt;-</span> <span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">[[</span><span class="st">"RNA"</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">var.features</span></span>
<span><span class="va">n_abundant</span> <span class="op">&lt;-</span> <span class="fl">3000</span></span>
<span><span class="va">most_abundant_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">)</span>,</span>
<span>    decreasing <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">pbmc3k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="va">pbmc3k</span>, features <span class="op">=</span> <span class="va">features</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We notice that the <code>seurat_annotations</code> column has some
missing values. For simplicity, we will replace them with “NA”.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">$</span><span class="va">seurat_annotations</span><span class="op">)</span></span>
<span><span class="va">pbmc3k</span><span class="op">$</span><span class="va">seurat_annotations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">$</span><span class="va">seurat_annotations</span><span class="op">)</span></span>
<span><span class="va">pbmc3k</span><span class="op">$</span><span class="va">seurat_annotations</span><span class="op">[</span><span class="va">mask</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"NA"</span></span></code></pre></div>
<p>Select the features used for the stability assessment.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">var_features</span> <span class="op">&lt;-</span> <span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">[[</span><span class="st">"RNA"</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">var.features</span></span>
<span><span class="va">n_abundant</span> <span class="op">&lt;-</span> <span class="fl">3000</span></span>
<span><span class="va">most_abundant_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">)</span>,</span>
<span>    decreasing <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">steps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">500</span>, to <span class="op">=</span> <span class="fl">3000</span>, by <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">ma_hv_genes_intersection_sets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">steps</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">most_abundant_genes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">x</span><span class="op">]</span>, <span class="va">var_features</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">x</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ma_hv_genes_intersection</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">union</span>, <span class="va">ma_hv_genes_intersection_sets</span><span class="op">)</span></span>
<span><span class="va">ma_hv_steps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">ma_hv_genes_intersection_sets</span>, <span class="va">length</span><span class="op">)</span></span></code></pre></div>
<p>Assess the stability of the dimensionality reduction when PCA is used
as dimensionality reduction.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matrix_processing_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt_mtx</span>, <span class="va">actual_npcs</span> <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">actual_npcs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">actual_npcs</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dt_mtx</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">RhpcBLASctl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RhpcBLASctl/man/RhpcBLASctl-package.html" class="external-link">blas_set_num_threads</a></span><span class="op">(</span><span class="fu">foreach</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/getDoParWorkers.html" class="external-link">getDoParWorkers</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">embedding</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dt_mtx</span>, rank. <span class="op">=</span> <span class="va">actual_npcs</span><span class="op">)</span><span class="op">$</span><span class="va">x</span></span>
<span></span>
<span>    <span class="fu">RhpcBLASctl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RhpcBLASctl/man/RhpcBLASctl-package.html" class="external-link">blas_set_num_threads</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dt_mtx</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"PC_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">actual_npcs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pca_feature_stability</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assess_feature_stability.html">assess_feature_stability</a></span><span class="op">(</span></span>
<span>    data_matrix <span class="op">=</span> <span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">[[</span><span class="st">"RNA"</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">scale.data</span>,</span>
<span>    feature_set <span class="op">=</span> <span class="va">most_abundant_genes</span>,</span>
<span>    resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0.1</span>, to <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    steps <span class="op">=</span> <span class="va">steps</span>,</span>
<span>    n_repetitions <span class="op">=</span> <span class="va">n_repetitions</span>,</span>
<span>    feature_type <span class="op">=</span> <span class="st">"MA"</span>,</span>
<span>    graph_reduction_type <span class="op">=</span> <span class="st">"PCA"</span>,</span>
<span>    matrix_processing <span class="op">=</span> <span class="va">matrix_processing_function</span>,</span>
<span>    umap_arguments <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        min_dist <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        n_neighbors <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        metric <span class="op">=</span> <span class="st">"cosine"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ecs_thresh <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    clustering_algorithm <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: executing %dopar% sequentially: no parallel backend registered</span></span></code></pre>
<p>Plot the distribution of the celltypes on the UMAP embedding obtained
on the top 1000 Most Abundant genes.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pca_feature_stability</span><span class="op">$</span><span class="va">embedding_list</span><span class="op">$</span><span class="va">MA</span><span class="op">$</span><span class="st">"1000"</span><span class="op">)</span></span>
<span><span class="va">umap_df</span><span class="op">$</span><span class="va">celltypes</span> <span class="op">&lt;-</span> <span class="va">pbmc3k</span><span class="op">$</span><span class="va">seurat_annotations</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">umap_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">UMAP_1</span>, y <span class="op">=</span> <span class="va">UMAP_2</span>, color <span class="op">=</span> <span class="va">celltypes</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="dim_reduction_flexibility_files/figure-html/umap_pca-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="clustassess-using-harmony">ClustAssess using Harmony<a class="anchor" aria-label="anchor" href="#clustassess-using-harmony"></a>
</h2>
<p>We can also modify the function by adding an addition post-processing
step to the PCA. In this example, we will use the Harmony correction to
remove the “batch effect” created by the celltypes. <em>Note</em>: This
example is meant to exemplify how to use the Harmony correction in the
ClusAssess pipeline. The batch correction is actually not needed in the
PBMC 3k dataset.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matrix_processing_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt_mtx</span>, <span class="va">actual_npcs</span> <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">actual_npcs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">actual_npcs</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dt_mtx</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">RhpcBLASctl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RhpcBLASctl/man/RhpcBLASctl-package.html" class="external-link">blas_set_num_threads</a></span><span class="op">(</span><span class="fu">foreach</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/getDoParWorkers.html" class="external-link">getDoParWorkers</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">embedding</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dt_mtx</span>, rank. <span class="op">=</span> <span class="va">actual_npcs</span><span class="op">)</span><span class="op">$</span><span class="va">x</span></span>
<span></span>
<span>    <span class="fu">RhpcBLASctl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RhpcBLASctl/man/RhpcBLASctl-package.html" class="external-link">blas_set_num_threads</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dt_mtx</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"PC_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">actual_npcs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">embedding</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/harmony/man/RunHarmony.html" class="external-link">RunHarmony</a></span><span class="op">(</span><span class="va">embedding</span>, <span class="va">pbmc3k</span><span class="op">$</span><span class="va">seurat_annotations</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pca_harmony_feature_stability</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assess_feature_stability.html">assess_feature_stability</a></span><span class="op">(</span></span>
<span>    data_matrix <span class="op">=</span> <span class="va">pbmc3k</span><span class="op">@</span><span class="va">assays</span><span class="op">[[</span><span class="st">"RNA"</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">scale.data</span>,</span>
<span>    feature_set <span class="op">=</span> <span class="va">most_abundant_genes</span>,</span>
<span>    resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0.1</span>, to <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    steps <span class="op">=</span> <span class="va">steps</span>,</span>
<span>    n_repetitions <span class="op">=</span> <span class="va">n_repetitions</span>,</span>
<span>    feature_type <span class="op">=</span> <span class="st">"MA"</span>,</span>
<span>    graph_reduction_type <span class="op">=</span> <span class="st">"PCA"</span>,</span>
<span>    matrix_processing <span class="op">=</span> <span class="va">matrix_processing_function</span>,</span>
<span>    umap_arguments <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        min_dist <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        n_neighbors <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        metric <span class="op">=</span> <span class="st">"cosine"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ecs_thresh <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    clustering_algorithm <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Plot the distribution of the celltypes on the UMAP embedding obtained
on the top 1000 Most Abundant genes.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pca_harmony_feature_stability</span><span class="op">$</span><span class="va">embedding_list</span><span class="op">$</span><span class="va">MA</span><span class="op">$</span><span class="st">"1000"</span><span class="op">)</span></span>
<span><span class="va">umap_df</span><span class="op">$</span><span class="va">celltypes</span> <span class="op">&lt;-</span> <span class="va">pbmc3k</span><span class="op">$</span><span class="va">seurat_annotations</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">umap_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">UMAP_1</span>, y <span class="op">=</span> <span class="va">UMAP_2</span>, color <span class="op">=</span> <span class="va">celltypes</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="dim_reduction_flexibility_files/figure-html/umap_harmony-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="clusassess-in-the-atac-seq-data">ClusAssess in the ATAC-seq data<a class="anchor" aria-label="anchor" href="#clusassess-in-the-atac-seq-data"></a>
</h2>
<p>In this example we will showcase the flexibility of the
<code>assess_feature_stability</code> function by using the ATAC-seq
data. For this example, we will use the multiome PBMC dataset from the
<code>SeuratData</code> package.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stuart-lab/signac" class="external-link">Signac</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/InstallData.html" class="external-link">InstallData</a></span><span class="op">(</span><span class="st">"pbmcMultiome"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: The following packages are already installed and will not be</span></span>
<span><span class="co">## reinstalled: pbmcMultiome</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"pbmc.atac"</span><span class="op">)</span></span></code></pre></div>
<p>As presented in the (Signac)(<a href="https://stuartlab.org/signac/articles/pbmc_vignette" class="external-link uri">https://stuartlab.org/signac/articles/pbmc_vignette</a>)
package, the ATAC-seq data is usually processed using the TF-IDF
normalization followed by the the calculation of the singular values.
These two steps are also known as LSI (Latent Semantic Indexing).</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbmc.atac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stuartlab.org/signac/reference/RunTFIDF.html" class="external-link">RunTFIDF</a></span><span class="op">(</span><span class="va">pbmc.atac</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Performing TF-IDF normalization</span></span></code></pre>
<pre><code><span><span class="co">## Warning in RunTFIDF.default(object = GetAssayData(object = object, slot =</span></span>
<span><span class="co">## "counts"), : Some features contain 0 total counts</span></span></code></pre>
<p>Identify the highly variable peaks.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbmc.atac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stuartlab.org/signac/reference/FindTopFeatures.html" class="external-link">FindTopFeatures</a></span><span class="op">(</span><span class="va">pbmc.atac</span>, min.cutoff <span class="op">=</span> <span class="st">"q5"</span><span class="op">)</span></span>
<span><span class="va">var_peaks</span> <span class="op">&lt;-</span> <span class="va">pbmc.atac</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">ATAC</span><span class="op">@</span><span class="va">var.features</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>To speedup the assessment, set a parallel backend with 6 cores.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">RhpcBLASctl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RhpcBLASctl/man/RhpcBLASctl-package.html" class="external-link">blas_set_num_threads</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ncores</span> <span class="op">&lt;-</span> <span class="fl">6</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">ncores</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">my_cluster</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span></span>
<span>        <span class="va">ncores</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"PSOCK"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">my_cluster</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Assess the stability of the dimensionality reduction by varying the
number of highly variable peaks.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matrix_processing_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt_mtx</span>, <span class="va">actual_n_singular_values</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">actual_n_singular_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">actual_n_singular_values</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dt_mtx</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">RhpcBLASctl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RhpcBLASctl/man/RhpcBLASctl-package.html" class="external-link">blas_set_num_threads</a></span><span class="op">(</span><span class="fu">foreach</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/getDoParWorkers.html" class="external-link">getDoParWorkers</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">embedding</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stuartlab.org/signac/reference/RunSVD.html" class="external-link">RunSVD</a></span><span class="op">(</span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu">t</span><span class="op">(</span><span class="va">dt_mtx</span><span class="op">)</span>, n <span class="op">=</span> <span class="va">actual_n_singular_values</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">@</span><span class="va">cell.embeddings</span></span>
<span>    <span class="co"># remove the first component, as it does contain noise - see the Signac vignette</span></span>
<span>    <span class="va">embedding</span> <span class="op">&lt;-</span> <span class="va">embedding</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="va">actual_n_singular_values</span><span class="op">]</span></span>
<span></span>
<span>    <span class="fu">RhpcBLASctl</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RhpcBLASctl/man/RhpcBLASctl-package.html" class="external-link">blas_set_num_threads</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dt_mtx</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"LSI_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">actual_n_singular_values</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">embedding</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lsi_atac_feature_stability</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/assess_feature_stability.html">assess_feature_stability</a></span><span class="op">(</span></span>
<span>    data_matrix <span class="op">=</span> <span class="va">pbmc.atac</span><span class="op">@</span><span class="va">assays</span><span class="op">[[</span><span class="st">"ATAC"</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">data</span>,</span>
<span>    feature_set <span class="op">=</span> <span class="va">var_peaks</span>,</span>
<span>    resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0.1</span>, to <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    steps <span class="op">=</span> <span class="va">steps</span>,</span>
<span>    n_repetitions <span class="op">=</span> <span class="va">n_repetitions</span>,</span>
<span>    feature_type <span class="op">=</span> <span class="st">"HV_peaks"</span>,</span>
<span>    graph_reduction_type <span class="op">=</span> <span class="st">"PCA"</span>,</span>
<span>    matrix_processing <span class="op">=</span> <span class="va">matrix_processing_function</span>,</span>
<span>    umap_arguments <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        min_dist <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        n_neighbors <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        metric <span class="op">=</span> <span class="st">"cosine"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ecs_thresh <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    clustering_algorithm <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: No assay specified, setting assay as RNA by default.</span></span>
<span><span class="co">## No assay specified, setting assay as RNA by default.</span></span>
<span><span class="co">## No assay specified, setting assay as RNA by default.</span></span>
<span><span class="co">## No assay specified, setting assay as RNA by default.</span></span>
<span><span class="co">## No assay specified, setting assay as RNA by default.</span></span>
<span><span class="co">## No assay specified, setting assay as RNA by default.</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">foreach</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/registerDoSEQ.html" class="external-link">registerDoSEQ</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Plot the distribution of the celltypes on the UMAP embedding obtained
on the top 1000 Highly Variable peaks.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">lsi_atac_feature_stability</span><span class="op">$</span><span class="va">embedding_list</span><span class="op">$</span><span class="va">HV_peaks</span><span class="op">$</span><span class="st">"1000"</span><span class="op">)</span></span>
<span><span class="va">umap_df</span><span class="op">$</span><span class="va">celltypes</span> <span class="op">&lt;-</span> <span class="va">pbmc.atac</span><span class="op">$</span><span class="va">seurat_annotations</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">umap_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">UMAP_1</span>, y <span class="op">=</span> <span class="va">UMAP_2</span>, color <span class="op">=</span> <span class="va">celltypes</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="dim_reduction_flexibility_files/figure-html/umap_atac-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="session-info">Session info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.3.3 (2024-02-29 ucrt)</span></span>
<span><span class="co">## Platform: x86_64-w64-mingw32/x64 (64-bit)</span></span>
<span><span class="co">## Running under: Windows 11 x64 (build 22631)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] LC_COLLATE=Romanian_Romania.utf8  LC_CTYPE=Romanian_Romania.utf8   </span></span>
<span><span class="co">## [3] LC_MONETARY=Romanian_Romania.utf8 LC_NUMERIC=C                     </span></span>
<span><span class="co">## [5] LC_TIME=Romanian_Romania.utf8    </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: Europe/Bucharest</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] Signac_1.13.0                 data.table_1.15.4            </span></span>
<span><span class="co">##  [3] harmony_1.2.0                 Rcpp_1.0.12                  </span></span>
<span><span class="co">##  [5] ggplot2_3.5.0                 ClustAssess_1.0.0            </span></span>
<span><span class="co">##  [7] pbmcMultiome.SeuratData_0.1.4 pbmc3k.SeuratData_3.1.4      </span></span>
<span><span class="co">##  [9] SeuratData_0.2.2.9001         Seurat_5.0.3                 </span></span>
<span><span class="co">## [11] SeuratObject_5.0.1            sp_2.1-3                     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] RcppAnnoy_0.0.22        splines_4.3.3           later_1.3.2            </span></span>
<span><span class="co">##   [4] bitops_1.0-7            tibble_3.2.1            polyclip_1.10-6        </span></span>
<span><span class="co">##   [7] fastDummies_1.7.3       lifecycle_1.0.4         doParallel_1.0.17      </span></span>
<span><span class="co">##  [10] globals_0.16.3          lattice_0.22-5          MASS_7.3-60.0.1        </span></span>
<span><span class="co">##  [13] magrittr_2.0.3          plotly_4.10.4           sass_0.4.9             </span></span>
<span><span class="co">##  [16] rmarkdown_2.26          jquerylib_0.1.4         yaml_2.3.8             </span></span>
<span><span class="co">##  [19] httpuv_1.6.15           sctransform_0.4.1       spam_2.10-0            </span></span>
<span><span class="co">##  [22] spatstat.sparse_3.0-3   reticulate_1.35.0       cowplot_1.1.3          </span></span>
<span><span class="co">##  [25] pbapply_1.7-2           RColorBrewer_1.1-3      abind_1.4-5            </span></span>
<span><span class="co">##  [28] zlibbioc_1.48.2         Rtsne_0.17              GenomicRanges_1.54.1   </span></span>
<span><span class="co">##  [31] purrr_1.0.2             BiocGenerics_0.48.1     RCurl_1.98-1.14        </span></span>
<span><span class="co">##  [34] rappdirs_0.3.3          GenomeInfoDbData_1.2.11 IRanges_2.36.0         </span></span>
<span><span class="co">##  [37] S4Vectors_0.40.2        ggrepel_0.9.5           irlba_2.3.5.1          </span></span>
<span><span class="co">##  [40] listenv_0.9.1           spatstat.utils_3.0-4    goftest_1.2-3          </span></span>
<span><span class="co">##  [43] RSpectra_0.16-1         spatstat.random_3.2-3   fitdistrplus_1.1-11    </span></span>
<span><span class="co">##  [46] parallelly_1.37.1       pkgdown_2.0.7           leiden_0.4.3.1         </span></span>
<span><span class="co">##  [49] codetools_0.2-19        RcppRoll_0.3.0          tidyselect_1.2.1       </span></span>
<span><span class="co">##  [52] farver_2.1.1            matrixStats_1.2.0       stats4_4.3.3           </span></span>
<span><span class="co">##  [55] spatstat.explore_3.2-7  jsonlite_1.8.8          progressr_0.14.0       </span></span>
<span><span class="co">##  [58] ggridges_0.5.6          survival_3.5-8          iterators_1.0.14       </span></span>
<span><span class="co">##  [61] systemfonts_1.0.6       foreach_1.5.2           tools_4.3.3            </span></span>
<span><span class="co">##  [64] progress_1.2.3          ragg_1.3.0              ica_1.0-3              </span></span>
<span><span class="co">##  [67] glue_1.7.0              gridExtra_2.3           xfun_0.43              </span></span>
<span><span class="co">##  [70] GenomeInfoDb_1.38.8     dplyr_1.1.4             withr_3.0.0            </span></span>
<span><span class="co">##  [73] fastmap_1.1.1           fansi_1.0.6             digest_0.6.35          </span></span>
<span><span class="co">##  [76] R6_2.5.1                mime_0.12               textshaping_0.3.7      </span></span>
<span><span class="co">##  [79] colorspace_2.1-0        scattermore_1.2         tensor_1.5             </span></span>
<span><span class="co">##  [82] spatstat.data_3.0-4     RhpcBLASctl_0.23-42     utf8_1.2.4             </span></span>
<span><span class="co">##  [85] tidyr_1.3.1             generics_0.1.3          prettyunits_1.2.0      </span></span>
<span><span class="co">##  [88] httr_1.4.7              htmlwidgets_1.6.4       uwot_0.1.16.9000       </span></span>
<span><span class="co">##  [91] pkgconfig_2.0.3         gtable_0.3.4            lmtest_0.9-40          </span></span>
<span><span class="co">##  [94] XVector_0.42.0          htmltools_0.5.8         dotCall64_1.1-1        </span></span>
<span><span class="co">##  [97] scales_1.3.0            png_0.1-8               knitr_1.45             </span></span>
<span><span class="co">## [100] reshape2_1.4.4          nlme_3.1-164            cachem_1.0.8           </span></span>
<span><span class="co">## [103] zoo_1.8-12              stringr_1.5.1           KernSmooth_2.23-22     </span></span>
<span><span class="co">## [106] parallel_4.3.3          miniUI_0.1.1.1          desc_1.4.3             </span></span>
<span><span class="co">## [109] pillar_1.9.0            grid_4.3.3              vctrs_0.6.5            </span></span>
<span><span class="co">## [112] RANN_2.6.1              promises_1.2.1          xtable_1.8-4           </span></span>
<span><span class="co">## [115] cluster_2.1.6           evaluate_0.23           cli_3.6.2              </span></span>
<span><span class="co">## [118] compiler_4.3.3          Rsamtools_2.18.0        rlang_1.1.3            </span></span>
<span><span class="co">## [121] crayon_1.5.2            future.apply_1.11.2     labeling_0.4.3         </span></span>
<span><span class="co">## [124] plyr_1.8.9              fs_1.6.3                stringi_1.8.3          </span></span>
<span><span class="co">## [127] viridisLite_0.4.2       deldir_2.0-4            BiocParallel_1.36.0    </span></span>
<span><span class="co">## [130] munsell_0.5.1           Biostrings_2.70.3       lazyeval_0.2.2         </span></span>
<span><span class="co">## [133] spatstat.geom_3.2-9     SharedObject_1.16.0     Matrix_1.6-5           </span></span>
<span><span class="co">## [136] RcppHNSW_0.6.0          hms_1.1.3               patchwork_1.2.0        </span></span>
<span><span class="co">## [139] future_1.33.2           shiny_1.8.1.1           highr_0.10             </span></span>
<span><span class="co">## [142] ROCR_1.0-11             igraph_2.0.3            memoise_2.0.1          </span></span>
<span><span class="co">## [145] bslib_0.7.0             fastmatch_1.1-4</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Arash Shahsavari, Andi Munteanu, Miguel Larraz Lopez de Novales, Irina Mohorianu.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
